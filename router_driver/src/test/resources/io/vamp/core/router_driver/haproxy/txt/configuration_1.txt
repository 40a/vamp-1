
global
  pidfile 33000
  daemon
  maxconn 4096
  stats socket haproxy_stat level admin
  log /var/run/vamp.log.sock local0

  defaults
    log global
    mode http
    option dontlognull
    option redispatch
    option clitcpka
    option srvtcpka
    option http-keep-alive
    retries 3
    maxconn 500000

    # slowloris protection: clients should send their full http request in the configured time
    timeout http-request 5s
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms

  listen stats :1988
    mode http
    stats enable
    stats uri /
    stats refresh 2s
    stats realm Haproxy\ Stats
    stats auth haproxy:haproxy


frontend name
  mode http
  bind 0.0.0.0:8080             
  option httplog                                               
  
  bind unix@/tmp/vamp_test_be_1_a.sock accept-proxy 
  option http-server-close                                     

  log-format {"timestamp": %t, "frontend": "%f", "method": "%r", "captured_request_headers": "%hrl", "captures_response_headers": "%hsl"}

  ###
  #
  # Spike/Rate Limiting & Quota Management
  #
  # We use a stick table to keep track of TCP connections rates and bytes send out.
  # On these metrics we set rules to designate upper limits. When limits are hit
  # we reroute the traffic to a specific abusers backend.
  #
  ###
  
  # Start HTTP spike limit generation
  stick-table type ip size 200k expire 10s store http_req_rate(1s)
  # Values below are specific to the backend.
  # Track the request and set ACL's.
  tcp-request content track-sc1 src
  acl marked_as_abuser sc1_http_req_rate gt 10000
  use_backend abusers if marked_as_abuser
  # End HTTP spike limit generation.
  
  
  # Start TCP spike limit generation
  stick-table type ip size 200k expire 10s store conn_rate(1s)
  # Values below are specific to the backend.
  # Track the request and set ACL's.
  tcp-request content track-sc2 src
  acl marked_as_abuser sc2_conn_rate gt 10000
  use_backend abusers if marked_as_abuser
  # End TCP spike limit generation.
  

  ###
  #
  # Filter Management
  #
  # Set filters with optional negation.
  #
  ###
  
  acl ie hdr_sub(user-agent) MSIE
  use_backend test_be_1_b if ie
  
  default_backend test_be_1



backend name1
  mode http
  balance roundrobin       
  

  
  server server1 unix@/tmp/vamp_test_be_1_a.sock send-proxy weight 100
  
  

backend name2
  mode http
  balance roundrobin       
  

  
  

  option forwardfor
  
  http-response set-header X-Vamp-Server-Name %s
  http-response set-header X-Vamp-Server-ResponseTime %t
  cookie vamp_srv insert indirect nocache httponly maxidle 5m maxlife 1h
  

  
  server test_be1_a_2 192.168.59.103:8082 cookie test_be1_a_2 weight 100 maxconn 1000 check inter 10
  

  option abortonclose      
  option allbackups        
  option checkcache        
  option forwardfor        
  option http-server-close 
  option httpchk           
  option ssl-hello-chk     
  option tcpka             
  option tcp-smart-accept  
  option tcp-smart-connect 
  option tcplog            
  

backend abusers
  mode http
  errorfile 409 /error/500rate.http
