# HAProxy 1.6
global
  pidfile /opt/vamp/haproxy.pid
  server-state-file /opt/vamp/haproxy_server_state

  daemon
  maxconn 4096
  log /opt/vamp/haproxy.log.sock local0

  defaults
    log global
    mode http
    option dontlognull
    option redispatch
    option clitcpka
    option srvtcpka
    option http-keep-alive
    retries 3
    maxconn 500000

    # slowloris protection: clients should send their full http request in the configured time
    timeout http-request 60s
    timeout connect 50s
    timeout client 50s
    timeout server 50s

  listen stats
    bind :1988
    mode http
    stats enable
    stats uri /
    stats refresh 2s
    stats realm Haproxy\ Stats
    stats auth haproxy:haproxy

# frontend: name
frontend name
  bind 0.0.0.0:8080             
  
  option httplog
  log-format {"ci":"%ci","cp":%cp,"t":"%t","ft":"%ft","b":"%b","s":"%s","Tq":%Tq,"Tw":%Tw,"Tc":%Tc,"Tr":%Tr,"Tt":%Tt,"ST":%ST,"B":%B,"CC":"%CC","CS":"%CS","tsc":"%tsc","ac":%ac,"fc":%fc,"bc":%bc,"sc":%sc,"rc":%rc,"sq":%sq,"bq":%bq,"hr":"%hr","hs":"%hs","r":%{+Q}r}

  option http-server-close                                     
  bind unix@/tmp/vamp_test_be_1_a.sock accept-proxy 

  mode http

  # destination: name1
  acl 22626cf3a6a55e2d hdr_sub(user-agent) MSIE
  acl 81b5022a1c5966ab hdr_sub(user-agent) Chrome
  use_backend name1 if 22626cf3a6a55e2d 81b5022a1c5966ab  

  # backend: name1
  default_backend name1

# backend: name1
backend name1
  mode http
  balance roundrobin       

  # server: server1
  server server1 unix@/tmp/vamp_test_be_1_a.sock send-proxy weight 100 

# backend: name2
backend name2
  mode http
  balance roundrobin       

  http-request set-path /images/%[path] if p_ext_jpg path_end -i .jpg

  option forwardfor
  
  # server: test_be1_a_2
  server test_be1_a_2 192.168.59.103:8082 cookie test_be1_a_2 weight 100 check inter 10 

  option abortonclose      
  option allbackups        
  option checkcache        
  option forwardfor        
  option http-server-close 
  option httpchk           
  option ssl-hello-chk     
  option tcpka             
  option tcp-smart-accept  
  option tcp-smart-connect 
  option tcplog            
